
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://nus-cs2030s.github.io/2021-s2/34-parallel.html">
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>34. Parallel Streams - CS2030S Programming Methodology II</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL(".",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#unit-34-parallel-streams" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="CS2030S Programming Methodology II" class="md-header__button md-logo" aria-label="CS2030S Programming Methodology II" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CS2030S Programming Methodology II
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              34. Parallel Streams
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="CS2030S Programming Methodology II" class="md-nav__button md-logo" aria-label="CS2030S Programming Methodology II" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    CS2030S Programming Methodology II
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Notes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Notes" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Introduction (00-03)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Introduction (00-03)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Introduction (00-03)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="00-overview.html" class="md-nav__link">
        0. Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="01-compiler.html" class="md-nav__link">
        1. Program and Compiler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="02-type.html" class="md-nav__link">
        2. Variable and Type
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="03-function.html" class="md-nav__link">
        3. Functions
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        OOP (04-16)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OOP (04-16)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          OOP (04-16)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="04-encapsulation.html" class="md-nav__link">
        4. Encapsulation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="05-infohiding.html" class="md-nav__link">
        5. Information Hiding
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="06-tell-dont-ask.html" class="md-nav__link">
        6. Tell, Don't Ask
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="07-static-field.html" class="md-nav__link">
        7. Class Fields
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="08-static-method.html" class="md-nav__link">
        8. Class Methods
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="09-composition.html" class="md-nav__link">
        9. Composition
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="10-inheritance.html" class="md-nav__link">
        10. Inheritance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="11-overriding.html" class="md-nav__link">
        11. Overriding
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="12-polymorphism.html" class="md-nav__link">
        12. Polymorphism
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="13-lsp.html" class="md-nav__link">
        13. Liskov Substitution Principle
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="14-abstract.html" class="md-nav__link">
        14. Abstract Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="15-interface.html" class="md-nav__link">
        15. Interface
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="16-wrapper.html" class="md-nav__link">
        16. Wrapper Class
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        Types (17-24)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Types (17-24)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Types (17-24)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="17-casting.html" class="md-nav__link">
        17. Casting
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="18-variance.html" class="md-nav__link">
        18. Variance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="19-exception.html" class="md-nav__link">
        19. Exception
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="20-generics.html" class="md-nav__link">
        20. Generics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="21-erasure.html" class="md-nav__link">
        21. Type Erasure
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="22-unchecked.html" class="md-nav__link">
        22. Unchecked Warnings
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="23-wildcard.html" class="md-nav__link">
        23. Wildcards
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="24-inference.html" class="md-nav__link">
        24. Type Inference
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      <label class="md-nav__link" for="__nav_2_4">
        Functional (25-33)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Functional (25-33)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Functional (25-33)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="25-immutability.html" class="md-nav__link">
        25. Immutability
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="26-nested-classes.html" class="md-nav__link">
        26. Nested Classes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="27-functions.html" class="md-nav__link">
        27. Functions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="28-box-maybe.html" class="md-nav__link">
        28. Box and Maybe
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="29-lazy.html" class="md-nav__link">
        29. Lazy Evaluation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="30-infinitelist.html" class="md-nav__link">
        30. Infinite List
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="31-stream.html" class="md-nav__link">
        31. Stream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="32-logger.html" class="md-nav__link">
        32. Loggable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="33-monad.html" class="md-nav__link">
        33. Monad
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" checked>
      
      <label class="md-nav__link" for="__nav_2_5">
        Parallel (34-37)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Parallel (34-37)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Parallel (34-37)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          34. Parallel Streams
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="34-parallel.html" class="md-nav__link md-nav__link--active">
        34. Parallel Streams
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-and-concurrent-programming" class="md-nav__link">
    Parallel and Concurrent Programming
  </a>
  
    <nav class="md-nav" aria-label="Parallel and Concurrent Programming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-concurrency" class="md-nav__link">
    What is concurrency?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-parallelism" class="md-nav__link">
    What is parallelism?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-computing" class="md-nav__link">
    Parallel computing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-stream" class="md-nav__link">
    Parallel Stream
  </a>
  
    <nav class="md-nav" aria-label="Parallel Stream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-parallelize-a-stream" class="md-nav__link">
    How to parallelize a stream
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-can-be-parallelized" class="md-nav__link">
    What can be parallelized?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interference" class="md-nav__link">
    Interference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateful-vs-stateless" class="md-nav__link">
    Stateful vs. Stateless
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#side-effects" class="md-nav__link">
    Side Effects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associativity" class="md-nav__link">
    Associativity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-of-parallel-stream" class="md-nav__link">
    Performance of Parallel Stream
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ordered-vs-unordered-source" class="md-nav__link">
    Ordered vs. Unordered Source
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="35-thread.html" class="md-nav__link">
        35. Threads
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="36-async.html" class="md-nav__link">
        36. Async
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="37-forkjoin.html" class="md-nav__link">
        37. Fork and Join
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="final-with-answers.pdf" class="md-nav__link">
        Final
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="environments.html" class="md-nav__link">
        Programming Environments
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Using Unix CLI
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Using Unix CLI" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Using Unix CLI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="unix-background.html" class="md-nav__link">
        Background
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="unix-essentials.html" class="md-nav__link">
        Essentials
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="unix-advanced.html" class="md-nav__link">
        Advanced
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="vim.html" class="md-nav__link">
        Using Vim
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="plugins.html" class="md-nav__link">
        Vim Plugins on PE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="style.html" class="md-nav__link">
        Java Style Guide
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="javadoc.html" class="md-nav__link">
        JavaDoc Guide
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="lab.html" class="md-nav__link">
        Lab Guide
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="references.html" class="md-nav__link">
        References
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-and-concurrent-programming" class="md-nav__link">
    Parallel and Concurrent Programming
  </a>
  
    <nav class="md-nav" aria-label="Parallel and Concurrent Programming">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-concurrency" class="md-nav__link">
    What is concurrency?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-parallelism" class="md-nav__link">
    What is parallelism?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-computing" class="md-nav__link">
    Parallel computing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-stream" class="md-nav__link">
    Parallel Stream
  </a>
  
    <nav class="md-nav" aria-label="Parallel Stream">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-parallelize-a-stream" class="md-nav__link">
    How to parallelize a stream
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-can-be-parallelized" class="md-nav__link">
    What can be parallelized?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interference" class="md-nav__link">
    Interference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateful-vs-stateless" class="md-nav__link">
    Stateful vs. Stateless
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#side-effects" class="md-nav__link">
    Side Effects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associativity" class="md-nav__link">
    Associativity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-of-parallel-stream" class="md-nav__link">
    Performance of Parallel Stream
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ordered-vs-unordered-source" class="md-nav__link">
    Ordered vs. Unordered Source
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="unit-34-parallel-streams">Unit 34: Parallel Streams</h1>
<h2 id="learning-objectives">Learning Objectives</h2>
<p>After attending this lecture, students should:</p>
<ul>
<li>be aware that a program can be broken into subtasks to run parallelly and/or concurrently </li>
<li>be aware of the issues caused by running subtasks parallelly and concurrently.</li>
<li>be aware that there exist tradeoffs in the number of subtasks and the processing overhead.</li>
<li>be familiar with how to process a stream parallelly and correctly.</li>
</ul>
<h2 id="parallel-and-concurrent-programming">Parallel and Concurrent Programming</h2>
<p>So far, the programs that we have written in CS2030S run <em>sequentially</em>.  What this means is that at any one time, there is only one instruction of the program running on a processor.</p>
<h3 id="what-is-concurrency">What is concurrency?</h3>
<p>A single-core processor can only execute one instruction at one time -- this means that only one <em>process</em> (or less precisely speaking, one application) can run at any one time.  Yet, when we use the computer, it <em>feels</em> as if we are running multiple processes at the same time.  The operating system, behind the scenes, is switching between the different processes, to give the user the illusion that they are running at the same time.</p>
<p>We can write a program so that it runs concurrently -- by dividing the computation into subtasks called <em>threads</em>. Such multi-thread programs are useful in two ways: (i) it allows us, the programmers, to separate unrelated tasks into threads, and write each thread separately; (ii) it improves the utilization of the processor.  For instance, if I/O is in one thread, and UI rendering is in another, then when the processor is waiting for I/O to complete, it can switch to the rendering thread to make sure that the slow I/O does not affect the responsiveness of UI.</p>
<h3 id="what-is-parallelism">What is parallelism?</h3>
<p>While concurrency gives the illusion of subtasks running at the same time, parallel computing refers to the scenario where multiple subtasks are truly running at the same time -- either we have a processor that is capable of running multiple instructions at the same time, or we have multiple cores/processors and dispatch the instructions to the cores/processors so that they are executed at the same time.</p>
<p>All parallel programs are concurrent, but not all concurrent programs are parallel.</p>
<p>Modern computers have more than one core/processor<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.  As such, the line between parallelism and concurrency is blurred.</p>
<h3 id="parallel-computing">Parallel computing</h3>
<p>Parallel computing is one of the major topics in computer science.  One can teach a whole module (or a focus area) on this topic alone.  The goal of this lecture is not to cover it in-depth but is to expose students in CS2030S to the concept of parallel computing in relation to the Stream abstraction in Java.</p>
<h2 id="parallel-stream">Parallel Stream</h2>
<p>We have seen that the Java <code>Stream</code> class is a powerful and useful class for processing data in a declarative style.  But, we have not fully unleashed the power of <code>Stream</code>.  The neatest thing about <code>Stream</code> is that it allows parallel operations on the elements of the stream in one single line of code.</p>
<p>Let's consider the following program that prints out all the prime numbers between 2,030,000 and 2,040,000.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2_030_000</span><span class="p">,</span> <span class="mi">2_040_000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>We can parallelize the code by adding the call <code>parallel()</code> into the stream.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2_030_000</span><span class="p">,</span> <span class="mi">2_040_000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
        <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>You may observe that the output has been reordered, although the same set of numbers are still being produced.  This is because <code>Stream</code> has broken down the numbers into subsequences, and run <code>filter</code> and <code>forEach</code> for each subsequence in parallel.  Since there is no coordination among the parallel tasks on the order of the printing, whichever parallel tasks that complete first will output the result to screen first, causing the sequence of numbers to be reordered.</p>
<p>If you want to produce the output in the order of input, use <code>forEachOrdered</code> instead of <code>forEach</code>, we will lose some benefits of parallelization because of this.</p>
<p>Suppose now that we want to compute the number of primes between 2,030,000 and 2,040,000.  We can run:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2_030_000</span><span class="p">,</span> <span class="mi">2_040_000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
        <span class="p">.</span><span class="na">count</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>The code above produces the same output regardless if it is being parallelized or not.</p>
<p>Note that the task above is stateless and does not produce any side effects.  Furthermore, each element is processed individually without depending on other elements.  Such computation is sometimes known as <em>embarrassingly parallel</em>.  The only communication needed for each of the parallel subtasks is to combine the result of <code>count()</code> from the subtasks into the final count (which has been implemented in <code>Stream</code> for us).</p>
<h3 id="how-to-parallelize-a-stream">How to parallelize a stream</h3>
<p>You have seen that adding <code>parallel()</code> to the chain of calls in a stream enables parallel processing of the stream.  Note that <code>parallel()</code> is a lazy operation -- it merely marks the stream to be processed in parallel.  As such, you can insert the call to <code>parallel()</code> anywhere in the chain.</p>
<div class="admonition note">
<p class="admonition-title">sequential()</p>
<p>There is a method <code>sequential()</code> which marks the stream to be process sequentially.  If you call both <code>parallel()</code> and <code>sequential()</code> in a stream,
the last call "wins".  The example below processes the stream 
sequentially:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>s.parallel().filter(x -&gt; x &lt; 0).sequential().forEach(..); 
</code></pre></div>
</td></tr></table></p>
</div>
<p>Another way to create a parallel stream is to call the method <code>parallelStream()</code> instead of <code>stream()</code> of the <code>Collector</code> class.  Doing so would create a stream that will be processed in parallel from the collection.</p>
<h3 id="what-can-be-parallelized">What can be parallelized?</h3>
<p>To ensure that the output of the parallel execution is correct, the stream operations must not <em>interfere</em> with the stream data, and most of the time must be <em>stateless</em>.  Side-effects should be kept to a minimum.</p>
<h3 id="interference">Interference</h3>
<p>Interference means that one of the stream operations modifies the source of the stream during the execution of the terminal operation.  For instance:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;Luke&quot;</span><span class="p">,</span> <span class="s">&quot;Leia&quot;</span><span class="p">,</span> <span class="s">&quot;Han&quot;</span><span class="p">));</span>
<span class="n">list</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
    <span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;Han&quot;</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;Chewie&quot;</span><span class="p">);</span> <span class="c1">// they belong together</span>
         <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="p">{});</span>
</code></pre></div>
</td></tr></table>
<p>would cause <code>ConcurrentModificationException</code> to be thrown.  Note that this non-interference rule applies even if we are using <code>stream()</code> instead of <code>parallelStream()</code>.</p>
<h3 id="stateful-vs-stateless">Stateful vs. Stateless</h3>
<p>A stateful lambda is one where the result depends on any state that might change during the execution of the stream.</p>
<p>For instance, the <code>generate</code> and <code>map</code> operations below are stateful, since they depend on the state of the standard input. Parallelizing this may lead to incorrect output.  To ensure that the output is correct, additional work needs to be done to ensure that state updates are visible to all parallel subtasks.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Stream</span><span class="p">.</span><span class="na">generate</span><span class="p">(</span><span class="n">scanner</span><span class="p">::</span><span class="n">nextInt</span><span class="p">)</span>
    <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">scanner</span><span class="p">.</span><span class="na">nextInt</span><span class="p">())</span>
    <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">::</span><span class="n">println</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h3 id="side-effects">Side Effects</h3>
<p>Side-effects can lead to incorrect results in parallel execution.  Consider the following code:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span>
    <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">19</span><span class="p">));</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">list</span><span class="p">.</span><span class="na">parallelStream</span><span class="p">()</span>
    <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</code></pre></div>
</td></tr></table>
<p>The <code>forEach</code> lambda generates a side effect -- it modifies <code>result</code>.  <code>ArrayList</code> is what we call a non-thread-safe data structure.  If two threads manipulate it at the same time, an incorrect result may result.</p>
<p>There are two ways to resolve this.  One, we can use the <code>.collect</code> method 
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">list</span><span class="p">.</span><span class="na">parallelStream</span><span class="p">()</span>
    <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">())</span>
</code></pre></div>
</td></tr></table>
Second, we can use a thread-safe data structure.  Java provides several in <code>java.util.concurrent</code> package, including <code>CopyOnWriteArrayList</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">list</span><span class="p">.</span><span class="na">parallelStream</span><span class="p">()</span>
    <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</code></pre></div>
</td></tr></table>
<h3 id="associativity">Associativity</h3>
<p>The <code>reduce</code> operation is inherently parallelizable, as we can easily reduce each sub-stream and then use the <code>combiner</code> to combine the results.  Consider this example:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Stream</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">).</span><span class="na">reduce</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>To allow us to run <code>reduce</code> in parallel, however, there are several rules that the <code>identity</code>, the <code>accumulator</code>, and the <code>combiner</code> must follow:</p>
<ul>
<li><code>combiner.apply(identity, i)</code> must be equal to <code>i</code>.</li>
<li>The <code>combiner</code> and the <code>accumulator</code> must be associative -- the order of applying must not matter.</li>
<li>The <code>combiner</code> and the <code>accumulator</code> must be compatible -- <code>combiner.apply(u, accumulator.apply(identity, t))</code> must equal to <code>accumulator.apply(u, t)</code></li>
</ul>
<p>The multiplication example above meetings the three rules:</p>
<ul>
<li><code>i * 1</code> equals <code>i</code></li>
<li><code>(x * y) * z</code> equals <code>x * (y * z)</code></li>
<li><code>u * (1 * t)</code> equals <code>u * t</code></li>
</ul>
<h2 id="performance-of-parallel-stream">Performance of Parallel Stream</h2>
<p>Let's go back to:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2_030_000</span><span class="p">,</span> <span class="mi">2_040_000</span><span class="p">)</span>
    <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
    <span class="p">.</span><span class="na">count</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>How much time can we save by parallelizing the code above?</p>
<p>Let's use the <a href="https://docs.oracle.com/javase/9/docs/api/java/time/Instant.html"><code>Instant</code></a> and <a href="https://docs.oracle.com/javase/9/docs/api/java/time/Duration.html"><code>Duration</code></a> class from Java to help us:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
    <span class="kt">long</span> <span class="n">howMany</span> <span class="o">=</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2_000_000</span><span class="p">,</span> <span class="mi">3_000_000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
        <span class="p">.</span><span class="na">count</span><span class="p">();</span>
    <span class="n">Instant</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">howMany</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">Duration</span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">).</span><span class="na">toMillis</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; ms&quot;</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>The code above measures roughly the time it takes to count the number of primes between 2 million and 3 million.  On my iMac, it takes slightly more than 1 second.  If I remove <code>parallel()</code>, it takes about 450-550 ms.  So we gain about 50% performance.</p>
<p>Can we parallelize some more?  Remember how we implement <code>isPrime</code><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">%</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Let's parallelize this to make this even faster!</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="p">.</span><span class="na">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
        <span class="p">.</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">%</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>If you run the code above, however, you will find that the code is not as fast as we expect. On my iMac, it takes about 18s, about 18 times slower!</p>
<p><em>Parallelizing a stream does not always improve the performance</em>.  Creating a thread to run a task incurs some overhead, and the overhead of creating too many threads might outweigh the benefits of parallelization.</p>
<h2 id="ordered-vs-unordered-source">Ordered vs. Unordered Source</h2>
<p>Whether or not the stream elements are <em>ordered</em> or <em>unordered</em> also plays a role in the performance of parallel stream operations.  A stream may define an <em>encounter order</em>.  Streams created from <code>iterate</code>, ordered collections (e.g., <code>List</code> or arrays), from <code>of</code>, are ordered.  Stream created from <code>generate</code> or unordered collections (e.g., <code>Set</code>) are unordered.</p>
<p>Some stream operations respect the encounter order.  For instance, both <code>distinct</code> and <code>sorted</code> preserve the original order of elements (if ordering is preserved, we say that an operation is <em>stable</em>).</p>
<p>The parallel version of <code>findFirst</code>, <code>limit</code>, and <code>skip</code> can be expensive on an ordered stream, since it needs to coordinate between the streams to maintain the order.</p>
<p>If we have an ordered stream and respecting the original order is not important, we can call <code>unordered()</code> as part of the chain command to make the parallel operations much more efficient.</p>
<p>The following, for example, takes about 700 ms on my iMac:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">Stream</span><span class="p">.</span><span class="na">iterate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>
        <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
        <span class="p">.</span><span class="na">limit</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="na">forEachOrdered</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="p">});</span>
</code></pre></div>
</td></tr></table>
<p>But, with <code>unordered()</code> inserted, it takes about 350ms, a 2x speedup!</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">Stream</span><span class="p">.</span><span class="na">iterate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span>
        <span class="p">.</span><span class="na">parallel</span><span class="p">()</span>
        <span class="p">.</span><span class="na">unordered</span><span class="p">()</span>
        <span class="p">.</span><span class="na">limit</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="na">forEachOrdered</span><span class="p">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="p">});</span>
</code></pre></div>
</td></tr></table>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>iPhone 12 comes with an A14 Bionic chip with six cores.  The fastest supercomputer in the world as of this writing, the <a href="https://en.wikipedia.org/wiki/Fugaku_(supercomputer)">Fugaku</a>, has 158,976 processors, each has 48 cores.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This is a more efficient version of the code you have seen since it stops testing after the square root of the <span class="arithmatex">\(n\)</span>.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="33-monad.html" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              33. Monad
            </div>
          </div>
        </a>
      
      
        <a href="35-thread.html" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              35. Threads
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright by Department of Computer Science, National University of Singapore 2021
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  </body>
</html>