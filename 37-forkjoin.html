
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://nus-cs2030s.github.io/2021-s2/37-forkjoin.html">
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>37. Fork and Join - CS2030S Programming Methodology II</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL(".",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#unit-37-fork-and-join" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="CS2030S Programming Methodology II" class="md-header__button md-logo" aria-label="CS2030S Programming Methodology II" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CS2030S Programming Methodology II
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              37. Fork and Join
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="CS2030S Programming Methodology II" class="md-nav__button md-logo" aria-label="CS2030S Programming Methodology II" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    CS2030S Programming Methodology II
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Notes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Notes" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Introduction (00-03)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Introduction (00-03)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Introduction (00-03)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="00-overview.html" class="md-nav__link">
        0. Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="01-compiler.html" class="md-nav__link">
        1. Program and Compiler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="02-type.html" class="md-nav__link">
        2. Variable and Type
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="03-function.html" class="md-nav__link">
        3. Functions
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        OOP (04-16)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="OOP (04-16)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          OOP (04-16)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="04-encapsulation.html" class="md-nav__link">
        4. Encapsulation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="05-infohiding.html" class="md-nav__link">
        5. Information Hiding
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="06-tell-dont-ask.html" class="md-nav__link">
        6. Tell, Don't Ask
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="07-static-field.html" class="md-nav__link">
        7. Class Fields
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="08-static-method.html" class="md-nav__link">
        8. Class Methods
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="09-composition.html" class="md-nav__link">
        9. Composition
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="10-inheritance.html" class="md-nav__link">
        10. Inheritance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="11-overriding.html" class="md-nav__link">
        11. Overriding
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="12-polymorphism.html" class="md-nav__link">
        12. Polymorphism
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="13-lsp.html" class="md-nav__link">
        13. Liskov Substitution Principle
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="14-abstract.html" class="md-nav__link">
        14. Abstract Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="15-interface.html" class="md-nav__link">
        15. Interface
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="16-wrapper.html" class="md-nav__link">
        16. Wrapper Class
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        Types (17-24)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Types (17-24)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Types (17-24)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="17-casting.html" class="md-nav__link">
        17. Casting
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="18-variance.html" class="md-nav__link">
        18. Variance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="19-exception.html" class="md-nav__link">
        19. Exception
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="20-generics.html" class="md-nav__link">
        20. Generics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="21-erasure.html" class="md-nav__link">
        21. Type Erasure
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="22-unchecked.html" class="md-nav__link">
        22. Unchecked Warnings
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="23-wildcard.html" class="md-nav__link">
        23. Wildcards
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="24-inference.html" class="md-nav__link">
        24. Type Inference
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      <label class="md-nav__link" for="__nav_2_4">
        Functional (25-33)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Functional (25-33)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Functional (25-33)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="25-immutability.html" class="md-nav__link">
        25. Immutability
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="26-nested-classes.html" class="md-nav__link">
        26. Nested Classes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="27-functions.html" class="md-nav__link">
        27. Functions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="28-box-maybe.html" class="md-nav__link">
        28. Box and Maybe
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="29-lazy.html" class="md-nav__link">
        29. Lazy Evaluation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="30-infinitelist.html" class="md-nav__link">
        30. Infinite List
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="31-stream.html" class="md-nav__link">
        31. Stream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="32-logger.html" class="md-nav__link">
        32. Loggable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="33-monad.html" class="md-nav__link">
        33. Monad
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" checked>
      
      <label class="md-nav__link" for="__nav_2_5">
        Parallel (34-37)
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Parallel (34-37)" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Parallel (34-37)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="34-parallel.html" class="md-nav__link">
        34. Parallel Streams
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="35-thread.html" class="md-nav__link">
        35. Threads
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="36-async.html" class="md-nav__link">
        36. Async
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          37. Fork and Join
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="37-forkjoin.html" class="md-nav__link md-nav__link--active">
        37. Fork and Join
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#thread-pool" class="md-nav__link">
    Thread Pool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fork-and-join" class="md-nav__link">
    Fork and Join
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forkjoinpool" class="md-nav__link">
    ForkJoinPool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order-of-fork-and-join" class="md-nav__link">
    Order of fork() and join()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="final-with-answers.pdf" class="md-nav__link">
        Final
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="environments.html" class="md-nav__link">
        Programming Environments
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Using Unix CLI
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Using Unix CLI" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Using Unix CLI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="unix-background.html" class="md-nav__link">
        Background
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="unix-essentials.html" class="md-nav__link">
        Essentials
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="unix-advanced.html" class="md-nav__link">
        Advanced
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="vim.html" class="md-nav__link">
        Using Vim
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="plugins.html" class="md-nav__link">
        Vim Plugins on PE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="style.html" class="md-nav__link">
        Java Style Guide
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="javadoc.html" class="md-nav__link">
        JavaDoc Guide
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="lab.html" class="md-nav__link">
        Lab Guide
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="references.html" class="md-nav__link">
        References
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#thread-pool" class="md-nav__link">
    Thread Pool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fork-and-join" class="md-nav__link">
    Fork and Join
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forkjoinpool" class="md-nav__link">
    ForkJoinPool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order-of-fork-and-join" class="md-nav__link">
    Order of fork() and join()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="unit-37-fork-and-join">Unit 37: Fork and Join</h1>
<h2 id="thread-pool">Thread Pool</h2>
<p>We now look under the hood of parallel <code>Stream</code> and <code>CompletableFuture&lt;T&gt;</code> to explore how Java manages its threads.  Recall that creating and destroying threads is not cheap, and as much as possible we should reuse existing threads to perform different tasks.  This goal can be achieved by using a <em>thread pool</em>. </p>
<p>A thread pool consists of (i) a collection of threads, each waiting for a task to execute, (ii) a collection of tasks to be executed.  Typically the tasks are put in a queue, and an idle thread picks up a task from the queue to execute.</p>
<p>To illustrate this concept, here is a trivial thread pool with a single thread:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">queue</span><span class="p">;</span>
<span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="na">dequeue</span><span class="p">();</span>
      <span class="n">r</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="na">start</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">queue</span><span class="p">.</span><span class="na">add</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>We assume that <code>Queue&lt;T&gt;</code> can be safely modified concurrently (i.e., it is thread-safe) in the sample code above.  Otherwise, just like the example you have seen in <a href="34-parallel.html">parallel streams</a> with <code>List</code>, items might be lost.</p>
<h2 id="fork-and-join">Fork and Join</h2>
<p>Java implements a thread pool called <code>ForkJoinPool</code> that is fine-tuned for the fork-join model of recursive parallel execution.  </p>
<p>The Fork-join model is essentially a parallel divide-and-conquer model of computation.  The general idea for the fork-join model is to solve a problem by breaking up the problem into identical problems but with smaller size (<em>fork</em>), then solve the smaller version of the problem recursively, then combine the results (<em>join</em>).   This repeats recursively until the problem size is small enough -- we have reached the base case and so we just solve the problem sequentially without further parallelization.</p>
<p>In Java, we can create a task that we can fork and join as an instance of abstract class <code>RecursiveTask&lt;T&gt;</code>.  <code>RecursiveTask&lt;T&gt;</code> supports the methods <code>fork()</code>, which submits a smaller version of the task for execution, and <code>join()</code> (which waits for the smaller tasks to complete and return).   <code>RecursiveTask&lt;T&gt;</code> has an abstract method <code>compute()</code>, which we, as the client, have to define to specify what computation we want to compute.</p>
<p>Here is a simple <code>RecursiveTask&lt;T&gt;</code> that recursively sums up the content of an array:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Summer</span> <span class="kd">extends</span> <span class="n">RecursiveTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FORK_THRESHOLD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">low</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">high</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="p">;</span>

    <span class="kd">public</span> <span class="nf">Summer</span><span class="p">(</span><span class="kt">int</span> <span class="n">low</span><span class="p">,</span> <span class="kt">int</span> <span class="n">high</span><span class="p">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">low</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="na">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Integer</span> <span class="nf">compute</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// stop splitting into subtask if array is already small.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">FORK_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">sum</span> <span class="o">+=</span> <span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">Summer</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Summer</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>
      <span class="n">Summer</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Summer</span><span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>
      <span class="n">left</span><span class="p">.</span><span class="na">fork</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">right</span><span class="p">.</span><span class="na">compute</span><span class="p">()</span> <span class="o">+</span> <span class="n">left</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table></p>
<p>To run this task, we run:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">Summer</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Summer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">array</span><span class="p">.</span><span class="na">length</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="na">compute</span><span class="p">();</span>
</code></pre></div>
</td></tr></table></p>
<p>The line <code>task.compute()</code> above is just like another method invocation.  It causes the method <code>compute()</code> to be invoked, and if the array is big enough, two new <code>Summer</code> instances, <code>left</code> and <code>right</code>, to be created.  <code>left</code>.  We then call <code>left.fork()</code>, which adds the tasks to a thread pool so that one of the threads can call its <code>compute()</code> method.  We subsequently call <code>right.compute()</code> (which is a normal method call).  Finally, we call <code>left.join()</code>, which blocks until the computation of the recursive sum is completed and returned.  We add the result from <code>left</code> and <code>right</code> together and return the sum.</p>
<p>There are other ways we can combine and order the execution of <code>fork()</code>, <code>compute()</code>, and <code>join()</code>.  Some are better than others.  We will explore more in the exercises.</p>
<h2 id="forkjoinpool"><code>ForkJoinPool</code></h2>
<p>Let's now explore the idea behind how Java manages the thread pool with fork-join tasks.  The details are beyond the scope of this module, but it would be interesting to note a few key points, as follows:</p>
<ul>
<li>Each thread has a queue of tasks.  </li>
<li>When a thread is idle, it checks its queue of tasks.  If the queue is not empty, it picks up a task at the head of the queue to execute (e.g., invoke its <code>compute()</code> method).  Otherwise, if the queue is empty, it picks up a task from the <em>tail</em> of the queue of another thread to run.  The latter is a mechanism called <em>work stealing</em>.</li>
<li>When <code>fork()</code> is called, the caller adds itself to the <em>head</em> of the queue of the executing thread.  This is done so that the most recently forked task gets executed next, similar to how normal recursive calls.</li>
<li>When <code>join()</code> is called, several cases might happen.  If the subtask to be joined hasn't been executed, its <code>compute()</code> method is called and the subtask is executed.  If the subtask to be joined has been completed (some other thread has stolen this and completed it), then the result is read, and <code>join()</code> returns.  If the subtask to be joined has been stolen and is being executed by another thread, then the current thread finds some other tasks to work on either in its local queue or steal another task from another queue.</li>
</ul>
<p>The beauty of the mechanism here is that the threads always look for something to do and they cooperate to get as much work done as possible.</p>
<p>The mechanism here is similar to that implemented in .NET and Rust.</p>
<h2 id="order-of-fork-and-join">Order of <code>fork()</code> and <code>join()</code></h2>
<p>One implication of how <code>ForkJoinPool</code> adds and removes tasks from the queue is the order in which we call <code>fork()</code> and <code>join()</code>.  Since the most recently forked task is likely to be executed next, we should <code>join()</code> the most recent <code>fork()</code> task first.  In other words, the order of forking should be the reverse of the order of joining.  </p>
<p>In the class <code>Summer</code> above,
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>      left.fork();
      right.fork();
      return right.join() + left.join();
</code></pre></div>
</td></tr></table></p>
<p>is more efficient than
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>      left.fork();
      right.fork();
      return left.join() + right.join();
</code></pre></div>
</td></tr></table></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="36-async.html" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              36. Async
            </div>
          </div>
        </a>
      
      
        <a href="final-with-answers.pdf" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Final
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright by Department of Computer Science, National University of Singapore 2021
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  </body>
</html>